import Replicate from 'replicate';
import { BaseImageGenerator } from './base-generator.js';
import { urlToBase64 } from '../utils/image-utils.js';

/**
 * SeedEdit 3.0 Generator
 * Replicate의 bytedance/seededit-3.0 모델을 사용한 이미지 생성
 */
export class FluxGenerator extends BaseImageGenerator {
  constructor() {
    super();

    if (!process.env.REPLICATE_API_TOKEN) {
      throw new Error('REPLICATE_API_TOKEN is not configured');
    }

    this.replicate = new Replicate({
      auth: process.env.REPLICATE_API_TOKEN,
    });
  }

  async generate({ imageBase64, mimeType, prompt }) {
    try {
      console.log('SeedEdit 3.0 생성 시작...');
      console.log('프롬프트 길이:', prompt.length, 'chars');

      // Base64를 data URL로 변환
      const imageDataUrl = `data:${mimeType};base64,${imageBase64}`;

      // Replicate API 호출
      console.log('Replicate API 호출 중...');
      const output = await this.replicate.run(
        "bytedance/seededit-3.0",
        {
          input: {
            image: imageDataUrl,
            prompt: prompt,
            // SeedEdit 3.0 파라미터
            seed: 42,
            guidance_scale: 7.5,
            num_inference_steps: 50,
            negative_prompt: "worst quality, low quality, normal quality, lowres, bad anatomy, bad hands, multiple eyebrow, cropped, extra limb, missing limbs, deformed hands, long neck, long body, bad hands, signature, username, artist name, conjoined fingers, deformed fingers, ugly eyes, imperfect eyes, skewed eyes, unnatural face, stiff face, stiff body, unbalanced body, unnatural body"
          }
        }
      );

      console.log('SeedEdit API 응답:', typeof output, Array.isArray(output) ? `배열(${output.length}개)` : '단일값');

      // output은 URL 배열 또는 단일 URL
      const imageUrl = Array.isArray(output) ? output[0] : output;

      if (!imageUrl) {
        throw new Error('SeedEdit API did not return image URL');
      }

      console.log('이미지 URL:', imageUrl);

      // URL에서 이미지 다운로드 및 Base64 변환
      const base64Data = await urlToBase64(imageUrl);

      console.log('SeedEdit 생성 완료');

      return {
        data: base64Data,
        mimeType: 'image/png'
      };

    } catch (error) {
      console.error('SeedEdit 생성 실패:', error);

      // Replicate 특정 에러 메시지 개선
      if (error.message && error.message.includes('Failed to fetch')) {
        throw new Error(`SeedEdit API connection failed: ${error.message}`);
      }

      throw new Error(`SeedEdit generation failed: ${error.message}`);
    }
  }
}
